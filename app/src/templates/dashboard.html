{% extends "base.html" %}
{% from "components/dashboard_nav.html" import dashboard_nav %}

{% block title %}API Keys - Klyne{% endblock %}

{% block content %}
{{ dashboard_nav(user, active_page="dashboard") }}

<div class="min-h-screen bg-gradient-to-br from-primary/5 via-secondary/3 to-accent/5 pt-20">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold mb-2">API Keys</h1>
                    <p class="text-lg text-base-content/80">Create and manage API keys for your Python packages</p>
                </div>
                <a href="/settings" class="btn btn-outline">
                    <i class="fas fa-user-cog mr-2"></i>
                    Account Settings
                </a>
            </div>
        </div>

        <!-- Create API Key Card -->
        <div class="klyne-card mb-8">
            <div class="card-body">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-plus text-primary"></i>
                    </div>
                    <h2 class="card-title text-2xl">Create New API Key</h2>
                </div>
                
                <p class="text-base-content/70 mb-6">
                    Each package needs its own unique API key for analytics tracking. API keys are public identifiers (like Google Analytics IDs) and are safe to include directly in your code.
                </p>
                
                <!-- Create new API key form -->
                <form action="/api/api-keys" method="POST" class="mb-6" id="create-key">
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text font-semibold flex items-center gap-2">
                                <i class="fas fa-box text-primary"></i>
                                Package Name
                            </span>
                        </label>
                        <input type="text" name="package_name" placeholder="e.g., pandas, numpy, requests" class="klyne-input" required>
                        <label class="label">
                            <span class="label-text-alt text-base-content/60">Use the exact name as published on PyPI</span>
                        </label>
                    </div>
                    <button type="submit" class="klyne-btn-primary">
                        <i class="fas fa-plus mr-2"></i>
                        Create API Key
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Existing API Keys Card -->
        <div class="klyne-card mb-8">
            <div class="card-body">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-secondary/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-list text-secondary"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="card-title text-2xl">Your API Keys</h2>
                        <p class="text-base-content/70">{{ api_keys|length }} API key{{ 's' if api_keys|length != 1 else '' }} created</p>
                    </div>
                </div>

                {% if api_keys %}
                    <div class="space-y-4">
                        {% for api_key in api_keys %}
                        <div class="card bg-base-200 border border-base-300 shadow-sm">
                            <div class="card-body p-4">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-box text-primary text-sm"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold text-lg">{{ api_key.package_name }}</h3>
                                                <p class="text-sm text-base-content/60">Created {{ api_key.created_at.strftime('%B %d, %Y') }}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-base-300 rounded-lg p-3 font-mono text-sm">
                                            <div class="flex justify-between items-center">
                                                <code class="text-base-content select-all" id="key-{{ loop.index }}">{{ api_key.key }}</code>
                                                <button class="btn btn-ghost btn-xs" onclick="copyApiKey('{{ api_key.key }}', {{ loop.index }})">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center gap-4 mt-3 text-sm text-base-content/60">
                                            <span><i class="fas fa-calendar-alt mr-1"></i>{{ api_key.created_at.strftime('%b %d, %Y') }}</span>
                                            <span><i class="fas fa-clock mr-1"></i>{{ api_key.created_at.strftime('%I:%M %p') }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="dropdown dropdown-end">
                                        <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </div>
                                        <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                            <li><a href="#" onclick="regenerateKey('{{ api_key.id }}')"><i class="fas fa-sync mr-2"></i>Regenerate</a></li>
                                            <li><a href="#" onclick="deleteKey('{{ api_key.id }}')"><i class="fas fa-trash mr-2 text-error"></i>Delete</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-base-300 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-key text-2xl text-base-content/40"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-2">No API Keys Yet</h3>
                        <p class="text-base-content/70 mb-6">Create your first API key above to start tracking package analytics</p>
                        <a href="#create-key" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>
                            Create First API Key
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Integration Instructions Card -->
        <div class="klyne-card">
            <div class="card-body">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-code text-accent"></i>
                    </div>
                    <h2 class="card-title text-2xl">Integration Instructions</h2>
                </div>
                
                <p class="text-base-content/70 mb-6">
                    Once you have an API key, integrate Klyne into your Python package with just a few lines of code:
                </p>
                
                <div class="mb-6">
                    <!-- Terminal Header -->
                    <div class="bg-base-300 rounded-t-lg p-3 border-b border-base-content/10">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-error rounded-full"></div>
                            <div class="w-3 h-3 bg-warning rounded-full"></div>
                            <div class="w-3 h-3 bg-success rounded-full"></div>
                            <div class="ml-4 text-sm text-base-content/60 font-mono">terminal</div>
                        </div>
                    </div>
                    
                    <!-- Code Content -->
                    <div class="bg-neutral text-neutral-content rounded-b-lg p-6 font-mono text-sm shadow-2xl overflow-x-auto">
                        <div class="space-y-2">
                            <!-- Install command -->
                            <div class="flex items-start space-x-2">
                                <span class="text-accent font-bold select-none">$</span>
                                <span class="text-white">pip install klyne</span>
                            </div>
                            
                            <!-- Python code -->
                            <div class="flex items-start space-x-2 pt-2">
                                <span class="text-accent font-bold select-none">></span>
                                <div class="text-left space-y-1 flex-1">
                                    <div>
                                        <span class="text-blue-300 font-semibold">import</span> 
                                        <span class="text-white">klyne</span>
                                    </div>
                                    <div class="pt-2"></div>
                                    <div>
                                        <span class="text-white">klyne</span><span class="text-cyan-400">.</span><span class="text-yellow-300">init</span><span class="text-gray-300">(</span>
                                    </div>
                                    <div class="pl-4">
                                        <span class="text-red-300">api_key</span><span class="text-gray-300">=</span><span class="text-green-400">'your_api_key_here'</span><span class="text-gray-300">,</span>
                                    </div>
                                    <div class="pl-4">
                                        <span class="text-red-300">project</span><span class="text-gray-300">=</span><span class="text-green-400">'your_package_name'</span><span class="text-gray-300">,</span>
                                    </div>
                                    <div class="pl-4">
                                        <span class="text-red-300">package_version</span><span class="text-gray-300">=</span><span class="text-green-400">'1.0.0'</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-300">)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Output -->
                            <div class="flex items-start space-x-2 pt-2">
                                <span class="text-success select-none">âœ“</span>
                                <span class="text-success/80">Analytics initialized successfully</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb"></i>
                    <div>
                        <div class="font-semibold">Quick Start Tip</div>
                        <div class="text-sm">
                            Add the initialization code to your package's <code class="bg-base-100 text-base-content px-2 py-1 rounded border border-base-300">__init__.py</code> file to automatically track usage when your package is imported. API keys are public and safe to commit to your repository.
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <a href="/analytics" class="btn btn-primary">
                        <i class="fas fa-chart-line mr-2"></i>
                        View Analytics
                    </a>
                    <a href="/docs" class="btn btn-outline">
                        <i class="fas fa-book mr-2"></i>
                        Documentation
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// API Key management functionality
document.addEventListener('DOMContentLoaded', function() {
    // Form submission handling
    const form = document.querySelector('form[action="/api/api-keys"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            
            // Reset after 5 seconds if no response
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }, 5000);
        });
    }
});

// Copy API key to clipboard
function copyApiKey(key, index) {
    navigator.clipboard.writeText(key).then(function() {
        // Show feedback
        const button = document.querySelector(`#key-${index}`).nextElementSibling;
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check text-success"></i>';
        
        setTimeout(() => {
            button.innerHTML = originalIcon;
        }, 2000);
        
        // Show toast notification
        showToast('API key copied to clipboard!', 'success');
    });
}

// Regenerate API key
function regenerateKey(keyId) {
    if (confirm('Are you sure you want to regenerate this API key? The old key will stop working immediately.')) {
        // TODO: Implement regeneration
        showToast('API key regeneration coming soon!', 'info');
    }
}

// Delete API key
function deleteKey(keyId) {
    if (confirm('Are you sure you want to delete this API key? This action cannot be undone.')) {
        // TODO: Implement deletion
        showToast('API key deletion coming soon!', 'info');
    }
}

// Toast notification helper
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-top toast-end`;
    toast.innerHTML = `
        <div class="alert alert-${type}">
            <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}