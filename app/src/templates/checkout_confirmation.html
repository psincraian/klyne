{% extends "base.html" %} {% from "components/header.html" import header %} {%
block title %}Checkout Confirmation - Klyne{% endblock %} {% block content %} {{
header(user=user) }}

<!-- Checkout Confirmation Section -->
<section
  class="min-h-screen pb-16 bg-gradient-to-br from-primary/10 via-secondary/5 to-accent/10"
>
  <div class="container mx-auto px-4">
    <div class="max-w-2xl mx-auto text-center">
      <!-- Loading State -->
      <div id="loading-state" class="mb-8">
        <div class="klyne-card">
          <div class="card-body p-12">
            <div
              class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-6"
            >
              <div
                class="loading loading-spinner loading-lg text-primary"
              ></div>
            </div>

            <h1 class="text-3xl font-bold mb-4">
              Processing Your Subscription
            </h1>

            <p class="text-lg text-base-content/80 mb-6">
              We're setting up your {{ plan_name }} subscription. This should
              only take a moment...
            </p>

            <div
              class="flex items-center justify-center gap-2 text-sm text-base-content/60"
            >
              <div class="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
              <span>Confirming payment</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Success State -->
      <div id="success-state" class="mb-8 hidden">
        <div class="klyne-card border-2 border-success">
          <div class="card-body p-12">
            <div
              class="w-16 h-16 bg-success/10 rounded-full flex items-center justify-center mx-auto mb-6"
            >
              <i class="fas fa-check text-success text-2xl"></i>
            </div>

            <h1 class="text-3xl font-bold mb-4 text-success">
              Subscription Activated!
            </h1>

            <p class="text-lg text-base-content/80 mb-6">
              Welcome to Klyne {{ plan_name }}! Your subscription is now active
              and you have access to all premium features.
            </p>

            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              <a href="/dashboard" class="klyne-btn-primary">
                <i class="fas fa-tachometer-alt mr-2"></i>
                Go to Dashboard
              </a>
              <a href="/analytics" class="btn btn-outline btn-lg">
                <i class="fas fa-chart-line mr-2"></i>
                View Analytics
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Error State -->
      <div id="error-state" class="mb-8 hidden">
        <div class="klyne-card border-2 border-error">
          <div class="card-body p-12">
            <div
              class="w-16 h-16 bg-error/10 rounded-full flex items-center justify-center mx-auto mb-6"
            >
              <i class="fas fa-exclamation-triangle text-error text-2xl"></i>
            </div>

            <h1 class="text-3xl font-bold mb-4 text-error">
              Subscription Setup Issue
            </h1>

            <p class="text-lg text-base-content/80 mb-6">
              We encountered an issue while setting up your subscription. Don't
              worry - if your payment was processed, we'll have you sorted out
              quickly.
            </p>

            <div class="bg-base-200 rounded-lg p-4 mb-6">
              <p class="text-sm text-base-content/70 mb-2">
                <strong>What to do next:</strong>
              </p>
              <ul class="text-sm text-base-content/70 space-y-1 text-left">
                <li>• Check your email for a payment confirmation</li>
                <li>• Try refreshing this page in a few minutes</li>
                <li>• Contact our support team if the issue persists</li>
              </ul>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              <a href="mailto:support@klyne.dev" class="klyne-btn-primary">
                <i class="fas fa-envelope mr-2"></i>
                Contact Support
              </a>
              <button
                onclick="window.location.reload()"
                class="btn btn-outline btn-lg"
              >
                <i class="fas fa-refresh mr-2"></i>
                Try Again
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Info -->
      <div class="text-center text-sm text-base-content/60">
        <p>
          Need help? Contact us at
          <a href="mailto:support@klyne.dev" class="link link-primary"
            >support@klyne.dev</a
          >
        </p>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const loadingState = document.getElementById("loading-state");
    const successState = document.getElementById("success-state");
    const errorState = document.getElementById("error-state");

    let pollCount = 0;
    const maxPolls = 24; // 2 minutes with 5-second intervals
    const pollInterval = 5000; // 5 seconds

    function showState(state) {
      loadingState.classList.add("hidden");
      successState.classList.add("hidden");
      errorState.classList.add("hidden");

      if (state === "loading") {
        loadingState.classList.remove("hidden");
      } else if (state === "success") {
        successState.classList.remove("hidden");
      } else if (state === "error") {
        errorState.classList.remove("hidden");
      }
    }

    async function checkSubscriptionStatus() {
      try {
        // Get user_id from URL parameters if available
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user_id");

        const url = userId
          ? `/api/subscription-status?user_id=${userId}`
          : "/api/subscription-status";

        const response = await fetch(url, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (!response.ok) {
          throw new Error("Failed to check subscription status");
        }

        const data = await response.json();

        if (data.status === "active") {
          showState("success");
          return true; // Stop polling
        }

        return false; // Continue polling
      } catch (error) {
        console.error("Error checking subscription status:", error);
        return false; // Continue polling
      }
    }

    function startPolling() {
      const pollTimer = setInterval(async () => {
        pollCount++;

        const isComplete = await checkSubscriptionStatus();

        if (isComplete) {
          clearInterval(pollTimer);
          return;
        }

        // After 2 minutes (24 polls × 5 seconds), show error state
        if (pollCount >= maxPolls) {
          clearInterval(pollTimer);
          showState("error");
        }
      }, pollInterval);

      // Initial check
      checkSubscriptionStatus().then((isComplete) => {
        if (isComplete) {
          clearInterval(pollTimer);
        }
      });
    }

    // Start the polling process
    startPolling();
  });
</script>
{% endblock %}
