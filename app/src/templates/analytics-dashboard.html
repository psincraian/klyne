{% extends "base.html" %}
{% from "components/dashboard_nav.html" import dashboard_nav %}

{% block title %}Analytics Dashboard - Klyne{% endblock %}

{% block extra_head %}
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
/* Dashboard-specific styles that override base */
.analytics-body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    margin: 0;
    padding: 0;
    padding-top: 80px; /* Account for fixed header */
}

/* Analytics page specific styles */

.analytics-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.analytics-title-section {
    margin-bottom: 2rem;
}

.analytics-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.analytics-subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.125rem;
    font-weight: 400;
}

.controls-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
}

.controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    align-items: end;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.control-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.control-input {
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    background: white;
}

.control-input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.refresh-btn {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.refresh-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.refresh-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
}

/* Removed accent line from stat cards */

.stat-icon {
    width: 3rem;
    height: 3rem;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    margin-bottom: 1rem;
    background: #e0e7ff;
    color: #6366f1;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.5rem;
    line-height: 1;
}

.stat-label {
    color: #6b7280;
    font-weight: 500;
    margin-bottom: 0.75rem;
}

.stat-change {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #9ca3af;
}

.stat-change.positive {
    color: #10b981;
}

.stat-change.negative {
    color: #ef4444;
}

.charts-section {
    display: grid;
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
}

.chart-row.full-width {
    grid-template-columns: 1fr;
}

.chart-container {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    position: relative;
    overflow: hidden;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chart-title i {
    color: #6366f1;
}

.chart-wrapper {
    position: relative;
    height: 350px;
}

.chart-wrapper.large {
    height: 450px;
}

.loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #9ca3af;
}

.spinner {
    width: 2rem;
    height: 2rem;
    border: 2px solid #e5e7eb;
    border-top: 2px solid #6366f1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 0.75rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-message {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    border: 1px solid #fca5a5;
    border-radius: 12px;
    padding: 1rem;
    color: #ef4444;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.no-data {
    text-align: center;
    padding: 3rem;
    color: #9ca3af;
}

.no-data-icon {
    font-size: 3rem;
    color: #9ca3af;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.no-data h3 {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
    color: #6b7280;
}

.empty-state {
    background: white;
    border-radius: 16px;
    padding: 4rem 2rem;
    text-align: center;
    margin: 2rem 0;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    grid-column: 1 / -1;
}

.empty-state-icon {
    width: 4rem;
    height: 4rem;
    border-radius: 50%;
    background: #e0e7ff;
    color: #6366f1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin: 0 auto 1.5rem;
}

.empty-state h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #111827;
}

.empty-state p {
    color: #6b7280;
    font-size: 1rem;
    line-height: 1.6;
    max-width: 24rem;
    margin: 0 auto 1.5rem;
}

.cta-button {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    padding: 0.75rem 2rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.cta-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    color: white;
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .analytics-container {
        padding: 1rem;
    }
    
    .analytics-header nav {
        padding: 0 1rem;
        flex-direction: column;
        gap: 1rem;
    }
    
    .analytics-nav-tabs {
        margin: 0;
        width: 100%;
        justify-content: center;
    }
    
    .analytics-title {
        font-size: 2rem;
    }
    
    .controls-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .chart-row {
        grid-template-columns: 1fr;
    }
    
    .stat-card {
        padding: 1.5rem;
    }
    
    .chart-container {
        padding: 1.5rem;
    }
    
    .chart-wrapper {
        height: 280px;
    }
}

/* Analytics specific responsive styles */
</style>
{% endblock %}

{% block content %}
<div class="analytics-body">
    {{ dashboard_nav(user, active_page="analytics") }}
    
    <div class="analytics-container">
        <div class="analytics-title-section">
            <h1 class="analytics-title">Welcome to Klyne</h1>
            <p class="analytics-subtitle">Monitor your package usage and performance metrics</p>
        </div>

        <div class="controls-card">
            <div class="controls-grid">
                <div class="control-group">
                    <label class="control-label">
                        <i class="fas fa-box"></i> Package
                    </label>
                    <select id="package-filter" class="control-input">
                        <option value="">All Packages</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">
                        <i class="fas fa-calendar-alt"></i> Start Date
                    </label>
                    <input type="date" id="start-date" class="control-input">
                </div>
                <div class="control-group">
                    <label class="control-label">
                        <i class="fas fa-calendar-alt"></i> End Date
                    </label>
                    <input type="date" id="end-date" class="control-input">
                </div>
                <div class="control-group">
                    <button id="refresh-data" class="refresh-btn">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>

        <div id="error-container"></div>
        
        <div id="overview-stats" class="stats-grid">
            <!-- Overview stats will be populated here -->
        </div>

        <div class="charts-section">
            <div class="chart-row full-width">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-area"></i>
                            Usage Over Time
                        </h3>
                    </div>
                    <div class="chart-wrapper large">
                        <canvas id="timeseries-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fab fa-python"></i>
                            Python Versions
                        </h3>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="python-chart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-desktop"></i>
                            Operating Systems
                        </h3>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="os-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let charts = {};
let currentPackage = '';
let packages = [];

// Wait for Chart.js to load
function waitForChart() {
    return new Promise((resolve) => {
        const checkChart = () => {
            if (typeof Chart !== 'undefined') {
                resolve();
            } else {
                setTimeout(checkChart, 50);
            }
        };
        checkChart();
    });
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', async function() {
    console.log('DOM loaded, waiting for Chart.js...');
    
    try {
        // Wait for Chart.js to be available
        await waitForChart();
        console.log('Chart.js loaded successfully');
        
        // Initialize the dashboard
        initializeDateInputs();
        loadInitialData();
        
        // Event listeners
        const refreshBtn = document.getElementById('refresh-data');
        const packageFilter = document.getElementById('package-filter');
        
        if (refreshBtn) {
            refreshBtn.addEventListener('click', refreshData);
        }
        
        if (packageFilter) {
            packageFilter.addEventListener('change', function() {
                currentPackage = this.value;
                refreshData();
            });
        }
    } catch (error) {
        console.error('Failed to initialize dashboard:', error);
        showError('Failed to load chart library. Please refresh the page.');
    }
});

function initializeDateInputs() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
}

async function loadInitialData() {
    try {
        showLoading();
        
        await Promise.all([
            loadOverviewData(),
            loadTimeSeriesData(),
            loadPythonVersionData(),
            loadOSData()
        ]);
        hideLoading();
    } catch (error) {
        console.error('Dashboard loading error:', error);
        showError('Failed to load dashboard data: ' + error.message);
        hideLoading();
    }
}

async function refreshData() {
    clearError();
    const refreshBtn = document.getElementById('refresh-data');
    const icon = refreshBtn.querySelector('i');
    
    // Add loading animation
    icon.classList.add('fa-spin');
    refreshBtn.disabled = true;
    
    try {
        await loadInitialData();
    } finally {
        // Remove loading animation
        icon.classList.remove('fa-spin');
        refreshBtn.disabled = false;
    }
}

async function loadOverviewData() {
    const params = new URLSearchParams();
    if (currentPackage) params.append('package_name', currentPackage);
    
    const response = await fetch(`/api/dashboard/overview?${params}`);
    if (!response.ok) throw new Error('Failed to load overview data');
    
    const data = await response.json();
    renderOverviewStats(data);
    updatePackageFilter(data);
}

async function loadTimeSeriesData() {
    const params = new URLSearchParams();
    if (currentPackage) params.append('package_name', currentPackage);
    
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    const response = await fetch(`/api/dashboard/timeseries?${params}`);
    if (!response.ok) throw new Error('Failed to load time series data');
    
    const data = await response.json();
    renderTimeSeriesChart(data);
}

async function loadPythonVersionData() {
    const params = new URLSearchParams();
    if (currentPackage) params.append('package_name', currentPackage);
    
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    const response = await fetch(`/api/dashboard/python-versions?${params}`);
    if (!response.ok) throw new Error('Failed to load Python version data');
    
    const data = await response.json();
    renderPythonVersionChart(data);
}

async function loadOSData() {
    const params = new URLSearchParams();
    if (currentPackage) params.append('package_name', currentPackage);
    
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    const response = await fetch(`/api/dashboard/operating-systems?${params}`);
    if (!response.ok) throw new Error('Failed to load OS data');
    
    const data = await response.json();
    renderOSChart(data);
}

function renderOverviewStats(data) {
    const container = document.getElementById('overview-stats');
    
    if (!data || data.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h3>No Analytics Data Yet</h3>
                <p>Start collecting analytics by creating API keys and integrating the Klyne SDK into your packages.</p>
                <a href="/dashboard" class="cta-button">
                    <i class="fas fa-key"></i>
                    Create API Key
                </a>
            </div>
        `;
        return;
    }
    
    // Aggregate totals across all packages
    const totals = data.reduce((acc, pkg) => ({
        events: acc.events + pkg.total_events,
        sessions: acc.sessions + pkg.total_sessions,
        packages: acc.packages + 1,
        avgDaily: acc.avgDaily + pkg.avg_daily_events
    }), { events: 0, sessions: 0, packages: 0, avgDaily: 0 });
    
    container.innerHTML = `
        <div class="stat-card fade-in">
            <div class="stat-icon">
                <i class="fas fa-box"></i>
            </div>
            <div class="stat-value">${totals.packages}</div>
            <div class="stat-label">Active Packages</div>
            <div class="stat-change">
                <i class="fas fa-info-circle"></i>
                Tracking ${totals.packages} package${totals.packages !== 1 ? 's' : ''}
            </div>
        </div>
        <div class="stat-card fade-in">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-value">${formatNumber(totals.events)}</div>
            <div class="stat-label">Total Events</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                All time activity
            </div>
        </div>
        <div class="stat-card fade-in">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-value">${formatNumber(totals.sessions)}</div>
            <div class="stat-label">Total Sessions</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                Unique user sessions
            </div>
        </div>
        <div class="stat-card fade-in">
            <div class="stat-icon">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-value">${Math.round(totals.avgDaily / totals.packages || 0)}</div>
            <div class="stat-label">Avg Daily Events</div>
            <div class="stat-change">
                <i class="fas fa-chart-bar"></i>
                Per package average
            </div>
        </div>
    `;
}

function updatePackageFilter(data) {
    const select = document.getElementById('package-filter');
    packages = data.map(pkg => pkg.package_name);
    
    // Clear and repopulate options
    select.innerHTML = '<option value="">All Packages</option>';
    packages.forEach(pkg => {
        const option = document.createElement('option');
        option.value = pkg;
        option.textContent = pkg;
        if (pkg === currentPackage) option.selected = true;
        select.appendChild(option);
    });
}

function renderTimeSeriesChart(data) {
    const canvas = document.getElementById('timeseries-chart');
    if (!canvas) {
        console.error('Timeseries chart canvas not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('Could not get canvas context');
        return;
    }
    
    if (charts.timeseries) {
        charts.timeseries.destroy();
    }
    
    if (!data.dates || data.dates.length === 0) {
        canvas.parentElement.innerHTML = `
            <div class="no-data">
                <div class="no-data-icon">
                    <i class="fas fa-chart-area"></i>
                </div>
                <h3>No time series data available</h3>
                <p>Data will appear here once you start receiving analytics events</p>
            </div>
        `;
        return;
    }
    
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        canvas.parentElement.innerHTML = `
            <div class="no-data">
                <div class="no-data-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Chart library not loaded</h3>
                <p>Please refresh the page</p>
            </div>
        `;
        return;
    }

    charts.timeseries = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [
                {
                    label: 'Events',
                    data: data.events,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Sessions',
                    data: data.sessions,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: false,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#6366f1',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    usePointStyle: true
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'MMM dd'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

function renderPythonVersionChart(data) {
    const canvas = document.getElementById('python-chart');
    if (!canvas) {
        console.error('Python chart canvas not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('Could not get canvas context');
        return;
    }
    
    if (charts.python) {
        charts.python.destroy();
    }
    
    if (!data || data.length === 0) {
        canvas.parentElement.innerHTML = `
            <div class="no-data">
                <div class="no-data-icon">
                    <i class="fab fa-python"></i>
                </div>
                <h3>No Python version data</h3>
                <p>Version distribution will appear here</p>
            </div>
        `;
        return;
    }
    
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        canvas.parentElement.innerHTML = `
            <div class="no-data">
                <div class="no-data-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Chart library not loaded</h3>
                <p>Please refresh the page</p>
            </div>
        `;
        return;
    }

    const colors = [
        '#6366f1', '#8b5cf6', '#ec4899', '#06b6d4', 
        '#10b981', '#f59e0b', '#ef4444', '#84cc16'
    ];
    
    charts.python = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(item => `Python ${item.python_version}`),
            datasets: [{
                data: data.map(item => item.session_count),
                backgroundColor: colors.slice(0, data.length),
                borderWidth: 3,
                borderColor: '#ffffff',
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 11,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const item = data[context.dataIndex];
                            return `${context.label}: ${item.session_percentage}% (${formatNumber(item.session_count)} sessions)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
}

function renderOSChart(data) {
    const canvas = document.getElementById('os-chart');
    if (!canvas) {
        console.error('OS chart canvas not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('Could not get canvas context');
        return;
    }
    
    if (charts.os) {
        charts.os.destroy();
    }
    
    if (!data || data.length === 0) {
        canvas.parentElement.innerHTML = `
            <div class="no-data">
                <div class="no-data-icon">
                    <i class="fas fa-desktop"></i>
                </div>
                <h3>No OS data</h3>
                <p>Operating system distribution will appear here</p>
            </div>
        `;
        return;
    }
    
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        canvas.parentElement.innerHTML = `
            <div class="no-data">
                <div class="no-data-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Chart library not loaded</h3>
                <p>Please refresh the page</p>
            </div>
        `;
        return;
    }

    const colors = [
        '#6366f1', '#8b5cf6', '#ec4899', '#06b6d4', 
        '#10b981', '#f59e0b', '#ef4444', '#84cc16'
    ];
    
    charts.os = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.map(item => item.os_type),
            datasets: [{
                data: data.map(item => item.session_count),
                backgroundColor: colors.slice(0, data.length),
                borderWidth: 3,
                borderColor: '#ffffff',
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 11,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const item = data[context.dataIndex];
                            return `${context.label}: ${item.session_percentage}% (${formatNumber(item.session_count)} sessions)`;
                        }
                    }
                }
            }
        }
    });
}

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    }
    if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toLocaleString();
}

function showLoading() {
    // Don't replace the canvas elements, just add loading overlay
    const containers = document.querySelectorAll('.chart-wrapper');
    containers.forEach(container => {
        // Only add loading if not already present
        if (!container.querySelector('.loading-spinner')) {
            const canvas = container.querySelector('canvas');
            if (canvas) {
                canvas.style.opacity = '0.3';
            }
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-spinner';
            loadingDiv.style.position = 'absolute';
            loadingDiv.style.top = '0';
            loadingDiv.style.left = '0';
            loadingDiv.style.right = '0';
            loadingDiv.style.bottom = '0';
            loadingDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            loadingDiv.style.zIndex = '10';
            loadingDiv.innerHTML = `
                <div class="spinner"></div>
                Loading chart data...
            `;
            
            container.style.position = 'relative';
            container.appendChild(loadingDiv);
        }
    });
}

function hideLoading() {
    // Remove loading overlays and restore canvas opacity
    const containers = document.querySelectorAll('.chart-wrapper');
    containers.forEach(container => {
        const loadingSpinner = container.querySelector('.loading-spinner');
        if (loadingSpinner) {
            loadingSpinner.remove();
        }
        
        const canvas = container.querySelector('canvas');
        if (canvas) {
            canvas.style.opacity = '1';
        }
    });
}

function showError(message) {
    const container = document.getElementById('error-container');
    container.innerHTML = `
        <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            ${message}
        </div>
    `;
}

function clearError() {
    document.getElementById('error-container').innerHTML = '';
}
</script>
{% endblock %}